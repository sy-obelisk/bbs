<?phpif(!defined('IN_DISCUZ')) {    exit('Access Denied');}class plugin_chs_tiebalist {    protected $enabled=false;    function __construct(){        global $_G;        $setting=&$_G['cache']['plugin']['chs_tiebalist'];        if ($setting['enabled']) {            $fid = intval($_G['fid']);            $forumselected=unserialize($setting['forumselected']);            if(in_array($fid,$forumselected)) $this->enabled=true;        }    }}class plugin_chs_tiebalist_forum extends plugin_chs_tiebalist {    function forumdisplay_thread_output(){        if (!$this->enabled) return;        global $_G;        if ($_G['forum']['picstyle'] == 0||$_G['cookie']['forumdefstyle']==1){            $threadlist = $_G['forum_threadlist'];            $tiebalist = array();            foreach($threadlist as $key => $value){//                $tiebalist[$key] ='<span class="replynum" title="'.lang('plugin/chs_tiebalist','replynum').'">'.$value['replies'].'</span>';            }            return $tiebalist;        }    }    function forumdisplay_thread_subject_output(){        if (!$this->enabled) return;        global $_G;        if ($_G['forum']['picstyle'] == 0||$_G['cookie']['forumdefstyle']==1){            $setting=&$_G['cache']['plugin']['chs_tiebalist'];            $threadlist = $_G['forum_threadlist'];            $tiebalist = array();            $messagelength=$setting['messagelength'];            $widthlimit=$setting['widthlimit'];            $picturenum=$setting['picturenum'];            $outsitethumb=$setting['outsitethumb'];            $thumbheight=$setting['thumbheight']?$setting['thumbheight']:80;            include_once libfile('function/post');            require_once('thumbbuilder.class.php');            $oTB=new ThumbBuilder();            $now=time();            $curdate=getdate($now);            $todayTime=mktime(0,0,0,$curdate['mon'],$curdate['mday'],$curdate['year']);            foreach($threadlist as $key => $value){                if ($value['displayorder']>0) {                    $tiebalist[$key]='<div class="tiebanode" style="height:auto;">';                }else {                    $tiebalist[$key]='<div class="tiebanode">';                }                if ($value['dblastpost']>=$todayTime) $value['lastpost']=date('H:i',$value['dblastpost']);                else $value['lastpost']=date('m-d',$value['dblastpost']);//                    $tiebalist[$key] .='<div class="publishinfo">//<p>//<a class="author" c="1" href="home.php?mod=space&uid='.$value['authorid'].'" title="'.lang('plugin/chs_tiebalist','threadauthor').':'.$value['author'].'" target="_blank">'.$value['author'].'</a>//</p>';////                    if ($value['displayorder']<=0){////                        $tiebalist[$key] .='<p class="lastpostwrap">//<span class="lastposter" title="'.lang('plugin/chs_tiebalist','lastposter').':'.$value['lastposter'].'">'.$value['lastposter'].'</span>//<span class="lastposttime">'.$value['lastpost'].'</span>//</p>';////                    }//                    $tiebalist[$key] .='</div>';                if (($value['displayorder']<=0)||$setting['stickthreadshow']) {                    $position=($value['special']==2)?2:1;                    $firstpost=C::t('forum_post')->fetch_all_by_tid_position('tid:'.$value['tid'],$value['tid'],$position);                    if (count($firstpost)>0&&$firstpost[0]['invisible']>=0){                        $post=&$firstpost[0];                        if ($messagelength>0) {                            $message=messagecutstr($post['message'],$messagelength);//                            $tiebalist[$key].= '<p class="introtext">'.$message.'</p>';                        }                        if ($picturenum<=0) continue;                        $attachs=C::t('forum_attachment_n')->fetch_all_by_pid_width('pid:'.$post['pid'],$post['pid'],$widthlimit);                        $len=count($attachs);                        if (($len<$picturenum)&&$outsitethumb){                            preg_match_all('/(\[img\]|\[img=\d{1,4}[x|\,]\d{1,4}\]|<img.*?src=")\s*([^\[\<\r\n]+?)\s*(\[\/img\]|".*>)/is', $post['message'], $imglist, PREG_SET_ORDER);                            foreach($imglist as $img){                                $attachs[]=array('attachment'=>$img[2]);                                $len++;                                if ($len>=$picturenum) break;                            }                        }                        if ($len>$picturenum){                            array_splice($attachs,$picturenum);                        }                        if ($attachs){                            $thumblist=$oTB->GetThreadThumbs($value['tid'],$attachs);                            if (count($thumblist)>0) {                                $tiebalist[$key].='<div class="picturedisplay"                            ><p class="thumblist cl" style="padding: 20px 0 0 30px !important;position: relative;left: 50px">';                                foreach($thumblist as $ii=>$thumb){                                    $tiebalist[$key].='                                    <span onclick="showPicture(this,'.$ii.');return false;" style="padding-left: 10px !important;">                                    <img src="'.$thumb.'" height="'.$thumbheight.'"/></span>';                                }                                $tiebalist[$key].='</p>';                                $margintop=($message)?'':'margin-top:20px;';                                $tiebalist[$key].=                                    '<div class="picturebox xs-image"  style="display:none;'.$margintop.';margin-left:80px;  padding: 20px;  border: 1px solid #e3e3e3;  border-radius: 4px;  background: #fff;  margin-top:20px;  ">                                    <div class="picturecontrol x-act" style=" color: #9699a3;    padding-bottom: 20px;">                                        <a class="x-btn" onclick="closePicture(this);return false;" href="javascript:;" >                                        <img src="../../../template/dean_tech_150528/images/Icon_shouqi.png"/>                                        '.lang('plugin/chs_tiebalist','close').'                                        </a>                                        &nbsp;&nbsp;&nbsp;                                        <a class="icon_viewlarge x-btn" href="" target="_blank">                                        <img src="../../../template/dean_tech_150528/images/Icon_chakandatu.png"/>                                        '.lang('plugin/chs_tiebalist','viewlarge').'</a>                                        &nbsp;&nbsp;&nbsp;                                        <a class="icon_turnleft x-btn" onclick="turnImg(this,1);return false;" href="javascript:;">                                       <img src="../../../template/dean_tech_150528/images/Icon_xuanzhuan.png"/>                                        旋转                                        </a>                                    </div>';                                foreach($attachs as $attach){                                    if ($attach['aid']) {                                        $forumimg=($attach['remote'] ? $_G['setting']['ftp']['attachurl'] : $_G['setting']['attachurl']).'forum/'.$attach['attachment'];                                    }else $forumimg=$attach['attachment'];                                    $tiebalist[$key].=                                        '<div class="bigpicture" style="display:none;">                                        <div class="picturewrap" onclick="closePicture(this);return false;" style="margin: 20px;">                                            <img class="picture" file="'.$forumimg.'" src="" />                                        </div>                                        <div class="goprevious"></div>                                        <div class="gonext"></div>                                    </div>';                                }//                                $tiebalist[$key].= '<a class="viewpost" href="forum.php?mod=viewthread&tid='.$value['tid'].'&extra=page%3D1" target="_blank"><span>'.lang('plugin/chs_tiebalist','enterpost').'</span></a></div></div>';                            }                        }                    }                }                $tiebalist[$key].='</div>';            }            return $tiebalist;        }    }    function forumdisplay_postbutton_top(){        if (!$this->enabled) return;        global $_G;        $setting=&$_G['cache']['plugin']['chs_tiebalist'];        $echo = '<link rel="stylesheet" type="text/css" href="source/plugin/chs_tiebalist/template/css/tiebalist.css" />';        $echo.='<!--[if IE]> <link rel="stylesheet" type="text/css" href="source/plugin/chs_tiebalist/template/css/ie.css" /><![endif]-->';        return $echo;    }    function  forumdisplay_threadlist_bottom() {        if (!$this->enabled) return;        global $_G;        $setting=&$_G['cache']['plugin']['chs_tiebalist'];        $echo .= '<script src="source/plugin/chs_tiebalist/template/js/tiebalist.js"  type="text/javascript"></script>';        $picturemaxwidth=$setting['picturemaxwidth'];        $echo .='<script type="text/javascript">var pictureMaxWidth='.$picturemaxwidth.';var hasTransform=testTransform();</script>';        return $echo;    }}?>